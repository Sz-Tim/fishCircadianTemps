---
title: "Fish circadian rhythms"
author: "Tim Szewczyk"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# libraries

See the [brms site](https://paul-buerkner.github.io/brms/) for installation instructions.
```{r}
library(tidyverse)
library(brms)
library(glue)
library(lisa)
theme_set(theme_classic())
group_col <- c(Control="#B68E52", Acclimation="#697A55", Experiment="#8399B3")
cmr.ls <- readRDS("figs/cmr_cmaps.RDS")
```


```{r}
mod_type <- c("RI", "RS")[2]
sp <- c("ZF", "Tilapia")[2]
```




# load data 

```{r}
data.df <- readxl::read_xlsx(dir("data", glue("{sp}_Data_matrix"), full.names=T),
                             1, col_types=c(rep("numeric", 6), "skip", "skip")) %>%
  mutate(ln_FishCount=log(FishCount+1),
         cos_ZT=cos(2*pi*ZT/24),
         sin_ZT=sin(2*pi*ZT/24),
         Chamber=factor(Chamber),
         Group=factor(Group, 
                      levels=c(3, 1, 2), 
                      labels=c("Control", "Acclimation", "Experiment")),
         Tank=factor(Tank))


str(data.df)
glimpse(data.df)
summary(data.df)
```




Fish select which chamber to be in. They want to know if the fish choose different chambers based on temperature regime and how that changes throughout the day. Random effect of Tank, fixed effect of Group, with different number of days for different groups and some missing values (camera errors)



# EDA 

```{r}
# More NAs in 0-3h acclim
ggplot(data.df, aes(ZT, fill=is.na(FishCount))) + 
  geom_bar(position="fill") +
  facet_grid(Chamber~Group) + 
  scale_fill_manual(values=c("grey", "red3")) + 
  labs(y="Proportion of observations")

ggplot(data.df, aes(Tank, ln_FishCount, fill=Group)) + 
  geom_boxplot() + facet_wrap(~Chamber) +
  scale_fill_manual(values=group_col)

wtChamber.df <- data.df %>% group_by(ZT, Days, Tank, Group) %>%
  mutate(Chamber=as.numeric(Chamber)) %>%
  summarise(wtChamber=sum(Chamber*FishCount, na.rm=T)/sum(FishCount, na.rm=T)) %>%
  ungroup
wtChamber.sum <- wtChamber.df %>%
  group_by(ZT, Group, Tank) %>%
  summarise(mn=mean(wtChamber, na.rm=T),
            se=sd(wtChamber, na.rm=T)/sqrt(sum(!is.na(wtChamber))))
wtChamber.df %>%
  ggplot(aes(ZT, colour=Tank)) + 
  geom_point(aes(y=wtChamber), alpha=0.5, shape=1) + 
  geom_point(data=wtChamber.sum, aes(y=mn)) +
  geom_linerange(data=wtChamber.sum, aes(ymin=mn-2*se, ymax=mn+2*se)) +
  facet_wrap(~Group) +
  ylim(1, 5) +
  labs(x="ZT", y="Preferred chamber") + 
  scale_colour_manual(values=lisa$MarcChagall[c(2,3,4)])

wtChamber.df %>%
  ggplot(aes(ZT, colour=Tank, fill=Tank)) + 
  geom_point(aes(y=wtChamber), alpha=0.75, shape=1) + 
  stat_smooth(data=wtChamber.sum, aes(y=mn), 
              method="lm", formula=y~cos(2*pi*x/24) + sin(2*pi*x/24)) +
  facet_wrap(~Group) +
  ylim(1, 5) +
  labs(x="ZT", y="Preferred chamber (observed)") +
  scale_colour_manual(values=lisa$MarcChagall[c(2,3,4)]) + 
  scale_fill_manual(values=lisa$MarcChagall[c(2,3,4)])

wtChamber.df %>%
  ggplot(aes(ZT, colour=Group, fill=Group)) + 
  geom_point(aes(y=wtChamber), alpha=0.75, shape=1) + 
  stat_smooth(data=wtChamber.sum, aes(y=mn), 
              method="lm", formula=y~cos(2*pi*x/24) + sin(2*pi*x/24)) +
  facet_wrap(~Tank) +
  ylim(1, 5) +
  labs(x="ZT", y="Preferred chamber (observed)") +
  scale_fill_manual(values=group_col) +
  scale_colour_manual(values=group_col)


ggplot(data.df, aes(sin_ZT, ln_FishCount, colour=Tank)) + 
  geom_point(shape=1, alpha=0.5) +
  stat_smooth(method="lm", aes(group=Tank)) + 
  facet_grid(Group~Chamber)  + 
  scale_colour_manual(values=lisa$MarcChagall[c(2,3,4)])

ggplot(data.df, aes(cos_ZT, ln_FishCount, colour=Tank)) + 
  geom_point(shape=1, alpha=0.5) +
  stat_smooth(method="lm", aes(group=Tank)) + 
  facet_grid(Group~Chamber)  + 
  scale_colour_manual(values=lisa$MarcChagall[c(2,3,4)])


data.df %>% 
  group_by(ZT, Group, Chamber) %>%
  summarise(mnFish=mean(FishCount, na.rm=T)) %>%
  ggplot(aes(ZT, Chamber, colour=mnFish, fill=mnFish)) + 
  geom_raster(interpolate=T) +
  facet_wrap(~Group) +
  scale_fill_gradientn("Mean observed count", 
                       colours=lisa_palette("KatsushikaHokusai", 1e3, "continuous")) +
  guides(fill=guide_colourbar(title.position="top", title.hjust=0.5)) +
  theme(legend.position="bottom",
        legend.key.width=unit(1, "cm")) + 
  ggtitle(sp)
ggsave(glue("figs/heatmap_observed_mean_{sp}.png"), height=4, width=8, dpi=300)
```







# run model 
```{r}
# remove NAs
data.noNA <- data.df %>% filter(complete.cases(.))

if(mod_type=="RI") {
  mod.form <- bf(ln_FishCount ~ 
                        I(cos(6.283185*ZT/24))*Chamber*Group + 
                        I(sin(6.283185*ZT/24))*Chamber*Group + 
                        (1|Tank))
} else {
  mod.form <- bf(ln_FishCount ~ 
                        I(cos(6.283185*ZT/24))*Chamber*Group + 
                        I(sin(6.283185*ZT/24))*Chamber*Group + 
                        (1 + I(cos(6.283185*ZT/24)) +
                           I(sin(6.283185*ZT/24)) + Chamber + Group||Tank))
}

# fit model
out <- brm(mod.form,
           prior=set_prior("normal(0,2)"), 
           control=list(adapt_delta=0.99, max_treedepth=20),
           iter=3000, warmup=2000, init=0,
           data=data.noNA, cores=4, refresh=50,
           save_model=glue("models/mod_{mod_type}.stan"),
           file=glue("models/out_{mod_type}_{sp}"))

pp_check(out)
summary(out) 
bayes_R2(out)
```






# view output 

cos(...): -1 at 12h, 1 at 0h
sin(...): -1 at 18h, 1 at 6h
```{r}
conditional_effects(out, effects="ZT:Chamber", 
                    conditions=data.frame(Group=levels(data.df$Group)))
conditional_effects(out, effects="ZT:Group", 
                    conditions=data.frame(Chamber=levels(data.df$Chamber)))
```




# Predicted patterns

```{r}
pred.lFish <- posterior_epred(out, newdata=data.df)
pred.Fish <- exp(pred.lFish)-1
out.df <- data.df %>%
  mutate(pred.mn=apply(pred.Fish, 2, median),
         pred.q025=apply(pred.Fish, 2, function(x) quantile(x, 0.025)),
         pred.q975=apply(pred.Fish, 2, function(x) quantile(x, 0.975)),
         pred.lmn=apply(pred.lFish, 2, median),
         pred.lq025=apply(pred.lFish, 2, function(x) quantile(x, 0.025)),
         pred.lq975=apply(pred.lFish, 2, function(x) quantile(x, 0.975)))
```

```{r}
heatmap.df <- expand_grid(ZT=unique(data.df$ZT),
                          Chamber=unique(data.df$Chamber),
                          Group=unique(data.df$Group)) 
heatmap.pred <- exp(posterior_epred(out, newdata=heatmap.df, re.form=NA))-1
heatmap.df <- heatmap.df %>%
  mutate(pred.mn=apply(heatmap.pred, 2, median),
         pred.q025=apply(heatmap.pred, 2, function(x) quantile(x, 0.025)),
         pred.q975=apply(heatmap.pred, 2, function(x) quantile(x, 0.975)))

ggplot(heatmap.df, aes(ZT, Chamber, fill=pred.mn)) + 
  geom_raster(interpolate=T) +
  facet_wrap(~Group) +
  scale_fill_gradientn("Mean observed count", 
                       colours=lisa_palette("KatsushikaHokusai", 1e3, "continuous")) +
  guides(fill=guide_colourbar(title.position="top", title.hjust=0.5)) +
  theme(legend.position="bottom",
        legend.key.width=unit(1, "cm")) + 
  ggtitle(sp)
ggsave(paste0("figs/heatmap_posterior_mean", sp, ".png"), height=4, width=8, dpi=300)

prefChamber.df_epred <- t(heatmap.pred) %>% as_tibble() %>%
  mutate(id=row_number()) %>%
  pivot_longer(1:4000, names_to="iter", values_to="predFish") %>%
  full_join(heatmap.df %>% mutate(id=row_number()), by="id") %>%
  group_by(ZT, Group, iter) %>%
  mutate(Chamber=as.numeric(Chamber)) %>%
  summarise(wtChamber=sum(Chamber*predFish)/sum(predFish)) %>%
  group_by(ZT, Group) %>%
  summarise(pred.mn=median(wtChamber),
            pred.q025=quantile(wtChamber, 0.025),
            pred.q05=quantile(wtChamber, 0.25),
            pred.q95=quantile(wtChamber, 0.75),
            pred.q975=quantile(wtChamber, 0.975))

prefChamber.df_epred %>%
  ggplot(aes(ZT)) + 
  geom_point(aes(y=pred.mn), size=1) + 
  geom_linerange(aes(ymin=pred.q05, ymax=pred.q95), size=1) +
  geom_linerange(aes(ymin=pred.q025, ymax=pred.q975), size=0.5) +
  facet_wrap(~Group) +
  ylim(1, 5) +
  labs(x="ZT", y="Preferred chamber")

prefChamber.df_epred %>%
  ggplot(aes(ZT, colour=Group)) + 
  geom_point(aes(y=pred.mn), shape=1) + 
  geom_linerange(aes(ymin=pred.q05, ymax=pred.q95), size=0.5) +
  geom_errorbar(aes(ymin=pred.q025, ymax=pred.q975), size=0.25, width=0.2) +
  ylim(1, 5) +
  labs(x="ZT", y="Preferred chamber") +
  scale_fill_manual(values=group_col) +
  scale_colour_manual(values=group_col) + 
  theme(legend.position=c(0.85, 0.15), 
        legend.title=element_blank()) +
  ggtitle(sp)
ggsave(paste0("figs/preferred_chamber_mnOnly", sp, ".png"), width=5, height=5, dpi=300)

prefChamber.df_epred %>%
  ggplot(aes(ZT, colour=Group, fill=Group)) + 
  geom_jitter(data=wtChamber.df, aes(y=wtChamber, shape=Group),
              alpha=0.5, size=0.5) +
  geom_line(aes(y=pred.mn)) + 
  geom_ribbon(aes(ymin=pred.q025, ymax=pred.q975), colour=NA, alpha=0.5) +
  ylim(1, 5) +
  labs(x="ZT", y="Preferred chamber") +
  scale_fill_manual(values=group_col) +
  scale_colour_manual(values=group_col) + 
  theme(legend.position=c(0.85, 0.15), 
        legend.title=element_blank()) +
  ggtitle(sp)
ggsave(paste0("figs/preferred_chamber", sp, ".png"), width=5, height=5, dpi=300)

prefChamber.df_epred %>%
  ggplot(aes(ZT, colour=Group, fill=Group)) + 
  geom_point(data=wtChamber.sum, aes(y=mn, shape=Group), alpha=0.75, size=0.75, 
             position=position_dodge(width=0.45)) +
  geom_errorbar(data=wtChamber.sum, aes(ymin=mn-se, ymax=mn+se), size=0.25,
                width=0.3, position=position_dodge(width=0.45)) +
  geom_line(aes(y=pred.mn)) + 
  geom_ribbon(aes(ymin=pred.q025, ymax=pred.q975), colour=NA, alpha=0.5) +
  ylim(1, 5) +
  labs(x="ZT", y="Preferred chamber") +
  scale_fill_manual(values=group_col) +
  scale_colour_manual(values=group_col) + 
  theme(legend.position=c(0.85, 0.15), 
        legend.title=element_blank()) +
  ggtitle(sp)
ggsave(paste0("figs/preferred_chamber_tankMeans", sp, ".png"), width=5, height=5, dpi=300)

ggplot(heatmap.df, aes(Chamber, pred.mn, colour=Group, fill=Group, group=Group)) + 
  geom_line() +
  geom_ribbon(aes(ymin=pred.q025, ymax=pred.q975), alpha=0.25, colour=NA) +
  facet_wrap(~ZT, nrow=4) + 
  ylim(0, NA) +
  scale_fill_manual(values=group_col) +
  scale_colour_manual(values=group_col) +
  labs(title=sp, y="Number of fish (fitted mean, 95% CI)")


heatmap.df %>% 
  group_by(Chamber, ZT, Group) %>%
  summarise(mn=mean(pred.mn)) %>%
  ggplot(aes(as.numeric(Chamber), mn, colour=ZT, group=ZT)) + 
  geom_line() +
  facet_wrap(~Group) +
  scale_colour_gradientn(colours=cmr.ls$seasons) +
  ylim(0, NA) +
  labs(title=sp, x="Chamber", y="Number of fish (fitted mean)")
ggsave(paste0("figs/tube_plots_", sp, ".png"), width=8, height=4, dpi=300)
```


